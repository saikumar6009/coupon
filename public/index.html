<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JioMart Coupon Generator & Checker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .sticky-top { position: sticky; top: 0; z-index: 2; }
  </style>
</head>
<body class="p-4 bg-light">
<div class="container">
  <h1 class="mb-4">üéüÔ∏è JioMart Coupon</h1>

  <form id="configForm" class="row g-3 mb-4">
    <div class="col-md-6"><label class="form-label">Cart ID</label><input class="form-control" id="cartId" required /></div>
    <div class="col-md-6"><label class="form-label">Auth Token</label><input class="form-control" id="authToken" required /></div>
    <div class="col-md-6"><label class="form-label">User ID</label><input class="form-control" id="userId" required /></div>
    <div class="col-md-6"><label class="form-label">PINCODE</label><input class="form-control" id="pin" required /></div>
    <div class="col-md-4"><label class="form-label">How many coupons?</label><input type="number" class="form-control" id="count" value="10" min="1" /></div>
    <div class="col-md-4"><label class="form-label">Prefix (optional)</label><input class="form-control" id="prefix" placeholder="e.g. T25 or M7N" /></div>
    <div class="col-md-4"><label class="form-label">Mode</label>
      <select class="form-select" id="mode">
        <option value="auto" selected>Auto (detect by prefix)</option>
        <option value="alternating">Alternating (Digit + Letter)</option>
        <option value="numeric">Numeric (T + 10 digits)</option>
      </select>
    </div>
    <div class="col-12"><label class="form-label">Custom Coupon List (optional)</label><textarea class="form-control" id="customCoupons" rows="4" placeholder="Paste coupons here..."></textarea></div>
    <div class="col-12 d-flex gap-2">
      <button class="btn btn-primary w-100">Generate / Check</button>
      <button type="button" id="downloadBtn" class="btn btn-success">‚¨áÔ∏è Download Valid Codes</button>
    </div>
  </form>

  <div class="card shadow-sm">
    <div class="card-body">
      <h4>Results</h4>
      <div style="max-height:400px; overflow-y:auto;">
        <table class="table table-bordered table-striped">
          <thead class="table-light sticky-top">
            <tr><th>#</th><th>Coupon</th><th>Status</th><th>Message</th><th>ID</th></tr>
          </thead>
          <tbody id="resultTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', ()=>{
  const digitWeights={ "1":0.2,"8":0.2,"9":0.18,"6":0.15,"0":0.12,"4":0.1,"2":0.015,"3":0.015,"5":0.015,"7":0.015 };
  const letterWeights={Z:.1,C:.1,N:.1,L:.08,J:.08,E:.08,A:.08,R:.07,T:.07,U:.06,W:.04,Y:.04,O:.04,Q:.03,K:.03,S:.03,D:.02,G:.02,X:.02,H:.02,F:.01,V:.01,M:.005,P:.005,B:.005,I:.005};
  "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").forEach(l=>{if(!letterWeights[l]) letterWeights[l]=0.001;});
  
  function weightedChoice(weights){
    const items=Object.keys(weights);
    const probs=Object.values(weights);
    let r=Math.random()*probs.reduce((a,b)=>a+b,0);
    for(let i=0;i<items.length;i++){r-=probs[i]; if(r<=0) return items[i];}
    return items[items.length-1];
  }

  function generateCoupon(prefix="",mode="auto"){
    const clean=(prefix||"").toUpperCase().replace(/[^A-Z0-9]/g,"");
    if(mode==="numeric"||(mode==="auto"&&/^T\d*$/.test(clean))){
      let code=clean.length?clean:"T"; while(code.length<11) code+=Math.floor(Math.random()*10); return code.slice(0,11);
    }
    let code=clean.slice(0,10), nextDigit=code.length===0?true:isNaN(code[code.length-1]);
    while(code.length<10){code+=nextDigit?weightedChoice(digitWeights):weightedChoice(letterWeights); nextDigit=!nextDigit;}
    return code;
  }

  const sleep=ms=>new Promise(r=>setTimeout(r,ms));
  let validCoupons=[];

  function createSessionPool(baseUserId, authToken, pin, size=20){
    const pool=[];
    for(let i=0;i<size;i++) pool.push({userId:"0".repeat(i)+baseUserId, authToken, pin, cooldown:0});
    return pool;
  }
  function pickNextSession(pool){
    const now=Date.now();
    for(let s of pool) if(s.cooldown<=now) return s;
    return pool.reduce((a,b)=>a.cooldown<a.cooldown?a:b);
  }

  document.getElementById("configForm").addEventListener("submit", async e=>{
    e.preventDefault();
    validCoupons=[]; 
    const cartId=document.getElementById("cartId").value;
    const authToken=document.getElementById("authToken").value;
    const baseUserId=document.getElementById("userId").value;
    const pin=document.getElementById("pin").value;
    const count=parseInt(document.getElementById("count").value);
    const prefix=document.getElementById("prefix").value.trim();
    const mode=document.getElementById("mode").value;
    const custom=document.getElementById("customCoupons").value.trim();
    const tableBody=document.getElementById("resultTable"); tableBody.innerHTML="";

    let coupons=custom.length?custom.split("\
