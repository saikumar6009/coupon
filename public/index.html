<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JioMart Coupon Checker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <h1 class="mb-4">JioMart Coupon Checker</h1>

    <form id="couponForm" class="mb-3">
      <div class="mb-2">
        <label class="form-label">Cart ID</label>
        <input type="text" id="cartId" class="form-control" required>
      </div>
      <div class="mb-2">
        <label class="form-label">Sessions (UserID,AuthToken,Pin per line)</label>
        <textarea id="sessions" class="form-control" rows="4" placeholder="userid,authtoken,pin" required></textarea>
      </div>
      <div class="mb-2">
        <label class="form-label">Coupons (one per line)</label>
        <textarea id="coupons" class="form-control" rows="6" placeholder="T1234567890" required></textarea>
      </div>
      <button class="btn btn-primary" type="submit">Start Checking</button>
    </form>

    <table class="table table-bordered" id="resultsTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Coupon</th>
          <th>Status</th>
          <th>Details</th>
          <th>Session</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="downloadBtn" class="btn btn-success mt-3" style="display:none;">Download Valid Coupons</button>
  </div>

  <script>
    const form = document.getElementById("couponForm");
    const tableBody = document.querySelector("#resultsTable tbody");
    const downloadBtn = document.getElementById("downloadBtn");
    let validCoupons = [];

    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      tableBody.innerHTML = "";
      validCoupons = [];
      downloadBtn.style.display = "none";

      const cartId = document.getElementById("cartId").value.trim();
      const sessions = document.getElementById("sessions").value.trim().split("\n")
        .map(l=>{const [userId,authToken,pin]=l.split(",").map(x=>x.trim());return{userId,authToken,pin,cooldown:0};})
        .filter(s=>s.userId&&s.authToken&&s.pin);
      const coupons = document.getElementById("coupons").value.trim().split("\n").map(c=>c.trim()).filter(Boolean);

      if(!cartId||!sessions.length||!coupons.length){alert("Please fill all fields correctly");return;}

      function pickNextSession(pool){
        const now = Date.now();
        for(const s of pool) if(s.cooldown<=now) return s;
        return pool.reduce((a,b)=>a.cooldown<a.cooldown?a:b);
      }

      let throttleDelay=3000;

      for(let i=0;i<coupons.length;i++){
        const coupon=coupons[i];
        const row=document.createElement("tr");
        row.innerHTML=`<td>${i+1}</td><td>${coupon}</td><td>⏳ Checking...</td><td></td><td>-</td>`;
        tableBody.appendChild(row);

        let attempt=0,success=false;
        while(attempt<5&&!success){
          const session=pickNextSession(sessions);
          row.cells[4].innerText=session.userId;
          try{
            const res=await fetch("/api/check-coupon",{
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body:JSON.stringify({coupon,cartId,userId:session.userId,authToken:session.authToken,pin:session.pin})
            });

            if(res.status===403||res.status===429){
              throttleDelay+=2000;
              session.cooldown=Date.now()+throttleDelay;
              attempt++;await sleep(throttleDelay);
              continue;
            }

            const ct=res.headers.get("content-type")||"";
            if(!ct.includes("application/json")) throw new Error("API blocked / non-JSON");

            const data=await res.json();
            if(data.result?.status==="success"||data.result?.result?.[0]?.applicable){
              const info=data.result?.additional_general_info||{};
              row.cells[2].innerHTML="✅ Valid";
              row.cells[3].innerHTML=`cart_id:${info.cart_id||"?"}, customer_id:${info.customer_id||"?"}`;
              row.className="table-success";validCoupons.push(coupon);
              success=true;throttleDelay=Math.max(throttleDelay-500,1000);
              session.cooldown=Date.now()+1000;
            }else{
              let reasonText="";
              if(data.error){ reasonText=JSON.stringify(data.error); }
              else if(data.result?.reason){ reasonText=JSON.stringify(data.result.reason); }
              else if(data.result?.result?.[0]){ reasonText=JSON.stringify(data.result.result[0]); }
              else{ reasonText="Unknown response: "+JSON.stringify(data); }

              row.cells[2].innerHTML="❌ Invalid";
              row.cells[3].innerHTML=reasonText;
              row.className="table-danger";
              success=true;
            }
          }catch(err){
            row.cells[2].innerHTML="⚠️ Error";
            row.cells[3].innerHTML=err.message;
            row.className="table-warning";
            throttleDelay+=2000;
            attempt++;await sleep(throttleDelay);
          }
        }

        await sleep(throttleDelay);
      }

      if(validCoupons.length){
        downloadBtn.style.display="inline-block";
        downloadBtn.onclick=()=>{
          const blob=new Blob([validCoupons.join("\n")],{type:"text/plain"});
          const a=document.createElement("a");
          a.href=URL.createObjectURL(blob);
          a.download="valid_coupons.txt";
          a.click();
        };
      }
    });
  </script>
</body>
</html>
